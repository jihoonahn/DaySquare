# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

default_platform(:ios)

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
def load_env_file
  env_file = File.join(__dir__, ".env.default")
  if File.exist?(env_file)
    File.readlines(env_file).each do |line|
      next if line.strip.empty? || line.start_with?("#")
      key, value = line.strip.split("=", 2)
      ENV[key] = value if key && value
    end
  end
end

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_env_file

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ (fastlane ë””ë ‰í† ë¦¬ì˜ ë¶€ëª¨)
PROJECT_ROOT = File.expand_path("..", __dir__)

# ê³µí†µ ë³€ìˆ˜
APP_IDENTIFIER = ENV["APP_IDENTIFIER"] || "me.jihoon.WithDay"
WIDGET_IDENTIFIER = "#{APP_IDENTIFIER}.Widget"
WORKSPACE_NAME = "WithDay.xcworkspace"
SCHEME_DEV = "WithDay-dev"
SCHEME_STAGE = "WithDay-stage"
SCHEME_PROD = "WithDay-prod"
EXPORT_OPTIONS_PLIST = "fastlane/ExportOptions.plist"

platform :ios do
  # MARK: - Match (ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ê´€ë¦¬)
  
  desc "Matchë¥¼ í†µí•´ ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ë™ê¸°í™”"
  lane :match_sync do
    match(
      type: "appstore",
      app_identifier: [APP_IDENTIFIER, WIDGET_IDENTIFIER],
      readonly: true
    )
  end

  desc "Matchë¥¼ í†µí•´ ìƒˆë¡œìš´ ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ìƒì„±"
  lane :match_new do
    match(
      type: "appstore",
      app_identifier: [APP_IDENTIFIER, WIDGET_IDENTIFIER]
    )
  end

  # MARK: - Tuist í”„ë¡œì íŠ¸ ìƒì„±

  desc "Tuist í”„ë¡œì íŠ¸ ìƒì„±"
  lane :generate do
    Dir.chdir(PROJECT_ROOT) do
      sh("tuist generate")
    end
  end

  desc "Tuist ì˜ì¡´ì„± ì„¤ì¹˜"
  lane :install_dependencies do
    Dir.chdir(PROJECT_ROOT) do
      sh("tuist install")
    end
  end

  desc "Tuist í”„ë¡œì íŠ¸ ì •ë¦¬"
  lane :clean_tuist do
    Dir.chdir(PROJECT_ROOT) do
      sh("tuist clean")
    end
  end

  # MARK: - ë¹Œë“œ

  desc "ê°œë°œ í™˜ê²½ ë¹Œë“œ"
  lane :build_dev do
    generate
    match_sync
    
    Dir.chdir(PROJECT_ROOT) do
      build_app(
        workspace: WORKSPACE_NAME,
        scheme: SCHEME_DEV,
        configuration: "DEV",
        export_method: "development",
        output_directory: "./build",
        output_name: "WithDay-dev.ipa",
        clean: true
      )
    end
  end

  desc "ìŠ¤í…Œì´ì§• í™˜ê²½ ë¹Œë“œ"
  lane :build_stage do
    generate
    match_sync
    
    Dir.chdir(PROJECT_ROOT) do
      build_app(
        workspace: WORKSPACE_NAME,
        scheme: SCHEME_STAGE,
        configuration: "STAGE",
        export_method: "app-store",
        export_options: {
          method: "app-store",
          provisioningProfiles: {
            APP_IDENTIFIER => "match AppStore #{APP_IDENTIFIER}",
            WIDGET_IDENTIFIER => "match AppStore #{WIDGET_IDENTIFIER}"
          }
        },
        output_directory: "./build",
        output_name: "WithDay-stage.ipa",
        clean: true
      )
    end
  end

  desc "í”„ë¡œë•ì…˜ í™˜ê²½ ë¹Œë“œ"
  lane :build_prod do
    generate
    match_sync
    
    Dir.chdir(PROJECT_ROOT) do
      build_app(
        workspace: WORKSPACE_NAME,
        scheme: SCHEME_PROD,
        configuration: "PROD",
        export_method: "app-store",
        export_options: {
          method: "app-store",
          provisioningProfiles: {
            APP_IDENTIFIER => "match AppStore #{APP_IDENTIFIER}",
            WIDGET_IDENTIFIER => "match AppStore #{WIDGET_IDENTIFIER}"
          }
        },
        output_directory: "./build",
        output_name: "WithDay-prod.ipa",
        clean: true
      )
    end
  end

  # MARK: - í…ŒìŠ¤íŠ¸

  desc "ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
  lane :test do
    generate
    
    Dir.chdir(PROJECT_ROOT) do
      run_tests(
        workspace: WORKSPACE_NAME,
        scheme: SCHEME_DEV,
        configuration: "DEV",
        clean: true,
        code_coverage: true
      )
    end
  end

  desc "íŠ¹ì • ìŠ¤í‚´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
  lane :test_scheme do |options|
    scheme = options[:scheme] || SCHEME_DEV
    generate
    
    Dir.chdir(PROJECT_ROOT) do
      run_tests(
        workspace: WORKSPACE_NAME,
        scheme: scheme,
        clean: true,
        code_coverage: true
      )
    end
  end

  # MARK: - ë²„ì „ ê´€ë¦¬

  desc "ë²„ì „ ë²ˆí˜¸ ì¦ê°€ (build number)"
  lane :bump_build_number do
    generate
    Dir.chdir(PROJECT_ROOT) do
      project_file = Dir.glob("*.xcodeproj").first
      if project_file
        increment_build_number(xcodeproj: project_file, target: "WithDay")
      else
        UI.user_error!("í”„ë¡œì íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € 'tuist generate'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")
      end
    end
  end

  desc "ë²„ì „ ë²ˆí˜¸ ì„¤ì •"
  lane :set_build_number do |options|
    build_number = options[:build_number]
    generate
    Dir.chdir(PROJECT_ROOT) do
      project_file = Dir.glob("*.xcodeproj").first
      if project_file
        increment_build_number(
          build_number: build_number,
          xcodeproj: project_file,
          target: "WithDay"
        )
      else
        UI.user_error!("í”„ë¡œì íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € 'tuist generate'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")
      end
    end
  end

  desc "ë²„ì „ ë¬¸ìì—´ ì¦ê°€ (version string)"
  lane :bump_version do |options|
    version_number = options[:version]
    generate
    Dir.chdir(PROJECT_ROOT) do
      project_file = Dir.glob("*.xcodeproj").first
      if project_file
        increment_version_number(
          version_number: version_number,
          xcodeproj: project_file,
          target: "WithDay"
        )
      else
        UI.user_error!("í”„ë¡œì íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € 'tuist generate'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")
      end
    end
  end

  # MARK: - Archive

  desc "ê°œë°œ í™˜ê²½ Archive ìƒì„±"
  lane :archive_dev do
    generate
    match_sync
    
    Dir.chdir(PROJECT_ROOT) do
      build_app(
        workspace: WORKSPACE_NAME,
        scheme: SCHEME_DEV,
        configuration: "DEV",
        export_method: "development",
        output_directory: "./build",
        output_name: "WithDay-dev",
        clean: true,
        skip_package_ipa: false
      )
    end
  end

  desc "ìŠ¤í…Œì´ì§• í™˜ê²½ Archive ìƒì„±"
  lane :archive_stage do
    generate
    match_sync
    
    Dir.chdir(PROJECT_ROOT) do
      build_app(
        workspace: WORKSPACE_NAME,
        scheme: SCHEME_STAGE,
        configuration: "STAGE",
        export_method: "app-store",
        export_options: {
          method: "app-store",
          provisioningProfiles: {
            APP_IDENTIFIER => "match AppStore #{APP_IDENTIFIER}",
            WIDGET_IDENTIFIER => "match AppStore #{WIDGET_IDENTIFIER}"
          }
        },
        output_directory: "./build",
        output_name: "WithDay-stage",
        clean: true,
        skip_package_ipa: false
      )
    end
  end

  desc "í”„ë¡œë•ì…˜ í™˜ê²½ Archive ìƒì„±"
  lane :archive_prod do
    generate
    match_sync
    
    Dir.chdir(PROJECT_ROOT) do
      build_app(
        workspace: WORKSPACE_NAME,
        scheme: SCHEME_PROD,
        configuration: "PROD",
        export_method: "app-store",
        export_options: {
          method: "app-store",
          provisioningProfiles: {
            APP_IDENTIFIER => "match AppStore #{APP_IDENTIFIER}",
            WIDGET_IDENTIFIER => "match AppStore #{WIDGET_IDENTIFIER}"
          }
        },
        output_directory: "./build",
        output_name: "WithDay-prod",
        clean: true,
        skip_package_ipa: false
      )
    end
  end

  # MARK: - TestFlight ë°°í¬

  desc "ìŠ¤í…Œì´ì§• í™˜ê²½ TestFlight ë°°í¬"
  lane :beta_stage do
    archive_stage
    upload_to_testflight(
      skip_waiting_for_build_processing: false,
      distribute_external: false,
      notify_external_testers: false
    )
  end

  desc "í”„ë¡œë•ì…˜ í™˜ê²½ TestFlight ë°°í¬"
  lane :beta_prod do
    archive_prod
    upload_to_testflight(
      skip_waiting_for_build_processing: false,
      distribute_external: false,
      notify_external_testers: false
    )
  end

  desc "TestFlight ë°°í¬ (ì™¸ë¶€ í…ŒìŠ¤í„°ì—ê²Œ ë°°í¬)"
  lane :beta_external do |options|
    scheme = options[:scheme] || SCHEME_STAGE
    
    if scheme == SCHEME_PROD
      archive_prod
    else
      archive_stage
    end
    
    upload_to_testflight(
      skip_waiting_for_build_processing: false,
      distribute_external: true,
      notify_external_testers: true
    )
  end

  # MARK: - App Store ë°°í¬

  desc "App Storeì— ë°°í¬"
  lane :release do
    generate
    
    Dir.chdir(PROJECT_ROOT) do
      # í”„ë¡œì íŠ¸ íŒŒì¼ì—ì„œ ë²„ì „ í™•ì¸
      project_file = Dir.glob("*.xcodeproj").first
      
      if project_file
        version = get_version_number(xcodeproj: project_file, target: "WithDay")
        build_number = get_build_number(xcodeproj: project_file, target: "WithDay")
      else
        # í”„ë¡œì íŠ¸ íŒŒì¼ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
        version = "1.0"
        build_number = "1"
      end
      
      UI.message("ğŸ“± ë°°í¬ ì •ë³´:")
      UI.message("   Version: #{version}")
      UI.message("   Build: #{build_number}")
    end
    
    # Archive ìƒì„±
    archive_prod
    
    # App Storeì— ì—…ë¡œë“œ
    upload_to_app_store(
      skip_metadata: false,
      skip_screenshots: false,
      force: true,
      submit_for_review: false,
      automatic_release: false
    )
  end

  # MARK: - ìœ í‹¸ë¦¬í‹°

  desc "í”„ë¡œì íŠ¸ ì •ë¦¬"
  lane :clean do
    clean_tuist
    Dir.chdir(PROJECT_ROOT) do
      sh("rm -rf build")
      sh("rm -rf DerivedData")
    end
    sh("rm -rf ~/Library/Developer/Xcode/DerivedData")
  end

  desc "ì½”ë“œ ì‚¬ì´ë‹ ì •ë³´ í™•ì¸"
  lane :check_signing do
    match_sync
    get_certificates
    get_provisioning_profile
  end

  desc "í”„ë¡œì íŠ¸ ì •ë³´ ì¶œë ¥"
  lane :info do
    workspace_path = File.join(PROJECT_ROOT, WORKSPACE_NAME)
    
    # í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ìƒì„±
    unless File.exist?(workspace_path)
      generate
    end
    
    Dir.chdir(PROJECT_ROOT) do
      # í”„ë¡œì íŠ¸ íŒŒì¼ ì°¾ê¸°
      project_file = Dir.glob("*.xcodeproj").first
      
      if project_file
        version = get_version_number(xcodeproj: project_file, target: "WithDay")
        build_number = get_build_number(xcodeproj: project_file, target: "WithDay")
      else
        # í”„ë¡œì íŠ¸ íŒŒì¼ì´ ì—†ìœ¼ë©´ Info.plistì—ì„œ ì½ê¸°
        info_plist_path = "Projects/App/iOS/Support/Info.plist"
        version = "1.0"
        build_number = "1"
        
        if File.exist?(info_plist_path)
          # ê°„ë‹¨í•œ plist íŒŒì‹± (CFBundleShortVersionStringê³¼ CFBundleVersion ì°¾ê¸°)
          plist_content = File.read(info_plist_path)
          if match = plist_content.match(/<key>CFBundleShortVersionString<\/key>\s*<string>([^<]+)<\/string>/)
            version = match[1]
          end
          if match = plist_content.match(/<key>CFBundleVersion<\/key>\s*<string>([^<]+)<\/string>/)
            build_number = match[1]
            # $(CURRENT_PROJECT_VERSION) ê°™ì€ ë³€ìˆ˜ê°€ ìˆìœ¼ë©´ xcconfigì—ì„œ ì½ê¸°
            if build_number.start_with?("$")
              xcconfig_path = "Configuration/Shared.xcconfig"
              if File.exist?(xcconfig_path)
                xcconfig = File.read(xcconfig_path)
                if match = xcconfig.match(/CURRENT_PROJECT_VERSION\s*=\s*(\d+)/)
                  build_number = match[1]
                end
              end
            end
          end
        end
      end
      
      UI.message("ğŸ“± WithDay í”„ë¡œì íŠ¸ ì •ë³´")
      UI.message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
      UI.message("   App Identifier: #{APP_IDENTIFIER}")
      UI.message("   Widget Identifier: #{WIDGET_IDENTIFIER}")
      UI.message("   Version: #{version}")
      UI.message("   Build Number: #{build_number}")
      UI.message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    end
  end

  # MARK: - CI/CD

  desc "CI í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì „ì²´ íŒŒì´í”„ë¼ì¸"
  lane :ci do
    # ì˜ì¡´ì„± ì„¤ì¹˜
    install_dependencies
    
    # í”„ë¡œì íŠ¸ ìƒì„±
    generate
    
    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    test
    
    # ë¹Œë“œ í™•ì¸
    build_dev
  end

  desc "CD í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ëŠ” ë°°í¬ íŒŒì´í”„ë¼ì¸"
  lane :cd do |options|
    environment = options[:environment] || "stage"
    
    case environment
    when "stage"
      beta_stage
    when "prod"
      beta_prod
    else
      UI.user_error!("Unknown environment: #{environment}. Use 'stage' or 'prod'")
    end
  end
end
